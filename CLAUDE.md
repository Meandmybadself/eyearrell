# IRL
This is a Node TypeScript service and UI providing a community directory for exchanging contact information.

## Core Technologies
* Node JS 22
* TypeScript
* PostGRES DB, using pooled connections.

## Node libraries
* Express
* `@prisma/client` - used for interacting with the PostGRES DB.
* `pg` - used for connecting to the PostGRES DB.
* `passport` - used to facilitate user authentication via Express sessions.
* `passport-local` - used for local authentication.
* `bcrypt` - used for hashing and salting passwords.
* `nodemailer` - used for sending emails via AWS SES SMTP to validate `User` email addresses and for resetting `User` passwords.
* `libphonenumber-js` - used for validating phone numbers.
* `zod` - used for validation of data.

## UI libraries / tools
* `lit` - web component framework
* `tailwindcss` - CSS
* `tailwindui` - UI
* `vite` - bundler

## Services
* `AWS SES SMTP` - Used for sending emails via SMTP to validate `User` email addresses and for resetting `User` passwords.
* `nominatim` - Used for geocoding addresses.

## Folder Organization
* `client` - Contains all UI
* `shared` - Contains shared utilities and TypeScript types
* `server` - Contains constants, web service code / REST API services

## Code Organization

### client
Organize code into `pages`, `components`, `utilities`, `services` folders.

## Concepts / Models
All models should have `createdAt` `updatedAt` properties.
Models should use soft delete flags to avoid actual deletion from the database.

### ContactInformation
ContactInformation is a many-to-one relationship, allowing multiple `ContactInformation` entities to be associated with a single entity.
It should be applied using a mapping table.

Properties:
* `type` - Enum `email` `phone` `address` `url`
* `label` - string
* `privacy` - Enum `private` `public`

### User
`User` is a credential set allowing a user to authenticate with the system.

Properties:
* `email`
* `password`
* `verificationToken` - Used when validating user.  If the `verificationToken` exists

### Person
`Person` is symbolic of an actual human being associated with the organization.  Every `Person` must have an associated `User` for authentication and system access.
A `Person` can also be associated with multiple `Group`s.  When a `Person` is associated with a `Group`, it should be done with a mapping table (`PersonGroup`) that identifies if the `Person` is an `admin` of the `Group`.  A `Person` can have many `ContactInformation` entities associated with it.

`Person` objects can also be transferred between `User`s.  This is done when `User`s are generated by a `Group` creator and later transferred to the actual people via a `Claim`

Properties:
* `id` - number - primary key 
* `firstName` - string
* `lastName` - string
* `displayId` - A unique, web-safe string for 
* `pronouns` - string
* `imageURL` - string
* `contactInformations` - comprised using the `ContactInformation` mapping tables

### System
`System` is the root of all models, detailing the organization in general.
It can have multiple `ContactInformation` entities associated with it.
Only one system can exist for the entire organization.

Properties:
* `name`
* `registrationOpen`
* `contactInformations` - comprised using the `ContactInformation` mapping tables
* `adminUsers` - A list of `User`s who can administrate the system.

### Group
`Group` is a collection of `Person`s.  It can be used to group `Person`s for a variety of purposes.

**Group Administrators:**
When a `Group` is created, the creator's first `Person` (ordered by `createdAt`) is automatically assigned as an administrator. Only administrators can modify group properties. When a `User` has multiple `Person`s, any of their `Person`s marked as admin grants modification permissions, but the first `Person` is used when initially creating groups.

Properties:
* `id` - Primary Key
* `displayId` - unique string (URL slug)
* `name`
* `description`
* `people` - comprised using the `Person` mapping tables via `PersonGroup`
* `parentGroup` - parent `Group` ID
* `adminPersons` - `Person`s with `isAdmin: true` in the `PersonGroup` mapping
* `memberPersons` - all `Person`s in the `PersonGroup` mapping
* `contactInformations` - comprised using the `ContactInformation` mapping tables
* `allowsAnyUserToCreateSubgroup` - boolean
* `publiclyVisible` - boolean

**Authorization Rules:**
* System admins can modify any group
* Only `Person`s marked as `isAdmin: true` in the `PersonGroup` relation can modify group properties
* The creator's first `Person` is automatically assigned as admin during group creation
* A `User` must have at least one `Person` before creating a group

## Steps for development
* Persist additional development steps in `TODOs.md`.  Add new tasks that need to be accomplished and mark tasks that have been previously completed.
* Following individual updates:
    * Run `pnpm build` to ensure that the applied changes are buildable.
    * Check to see if new functionality was added that already exists elsewhere in the system.

* Test changes to the service by using the Chrome DevTools MCP.  Browse to http://localhost:3000
    * Test credentials to login are stored as environment variables (TEST_EMAIL & TEST_PASSWORD), available to this process.
* If buildable and tested, make a git commit detailing the updates.

## Available Tools
* `gh` - Use for interacting with Github

---

# Code Map

This section provides a structural overview of the codebase for efficient navigation.

## Project Structure

```
irl-mobile/
├── client/          # Lit web components UI
├── service/         # Express REST API backend
├── shared/          # Shared types and constants
├── scripts/         # Deployment scripts
├── data/            # Data files and migrations
└── prd/             # Product documentation
```

## Service Module (`service/`)

### Entry Point
- `service/src/index.ts` - Express server setup, middleware, route registration

### Database
- `service/prisma/schema.prisma` - Prisma schema with all models and enums
- `service/src/lib/prisma.ts` - Prisma client singleton

### Configuration
- `service/src/config/passport.ts` - Local authentication strategy
- `service/src/config/cloudinary.ts` - Image upload config
- `service/src/lib/env-check.ts` - Environment variable validation

### Core Libraries
- `service/src/lib/email.ts` - AWS SES SMTP via nodemailer
- `service/src/lib/geocoding.ts` - Nominatim integration

### Middleware (`service/src/middleware/`)
| File | Purpose |
|------|---------|
| `auth.ts` | `requireAuth`, `requireSystemAdmin` |
| `authorization.ts` | Permission checks for persons/groups |
| `error-handler.ts` | Global error handling, `asyncHandler()` |
| `audit-logger.ts` | API request logging |
| `masquerade.ts` | Admin impersonation |
| `validation.ts` | Zod schemas, request validation |

### API Routes (`service/src/routes/`)
| File | Endpoints | Purpose |
|------|-----------|---------|
| `auth.ts` | `/api/auth/*` | Login, register, logout, email verification |
| `users.ts` | `/api/users` | User account management |
| `persons.ts` | `/api/persons` | Person profiles CRUD |
| `groups.ts` | `/api/groups` | Group management with hierarchy |
| `contact-information.ts` | `/api/contact-information` | Contact details |
| `contact-mappings.ts` | `/api/contact-mappings` | Map contacts to entities |
| `person-groups.ts` | `/api/person-groups` | Person-group membership |
| `claims.ts` | `/api/claims` | Person transfer mechanism |
| `group-invites.ts` | `/api/group-invites` | Group invitations |
| `interests.ts` | `/api/interests` | Interest/skill definitions |
| `person-interests.ts` | `/api/persons/:id/interests` | Person interest levels |
| `person-recommendations.ts` | `/api/persons/:id/recommendations` | Similar persons |
| `system.ts` | `/api/system` | Organization settings |
| `audit-logs.ts` | `/api/audit-logs` | API logging (admin) |
| `masquerade.ts` | `/api/masquerade` | Admin impersonation |
| `nearby.ts` | `/api/nearby` | Location-based discovery |
| `gamification.ts` | `/api/gamification/*` | Achievements, levels, points |
| `invitations.ts` | `/api/invitations` | Send group invites |

### Services (`service/src/services/`)
- `achievement-triggers.ts` - Achievement unlock conditions
- `gamification-service.ts` - Points, levels, leaderboards

### Utilities (`service/src/utils/`)
- `prisma-helpers.ts` - Common Prisma queries
- `cloudinary-upload.ts` - Image uploads
- `sanitization.ts` - Input sanitization
- `seed-*.ts` - Database seeding scripts

## Client Module (`client/`)

### Entry Point
- `client/src/index.ts` - Bootstrap app-root element
- `client/src/app.ts` - AppRoot LitElement, Redux store, router init

### Routing
- `client/src/router.ts` - Route definitions, protected/public routes

### State Management (`client/src/store/`)
- `index.ts` - Redux store factory
- `slices/auth.ts` - Authentication state
- `slices/entities.ts` - Normalized data (users, persons, groups)
- `slices/ui.ts` - Notifications, modals, loading
- `slices/system.ts` - Organization data
- `slices/masquerade.ts` - Impersonation state
- `selectors.ts` - Memoized selectors
- `schemas.ts` - Normalizr schemas

### Services
- `client/src/services/api-client.ts` - HTTP client for all API calls

### Pages (`client/src/pages/`)
| Page | Purpose |
|------|---------|
| `login-page.ts` | User login form |
| `register-page.ts` | User registration |
| `verify-email-page.ts` | Email verification |
| `profile-page.ts` | User account management |
| `home-page.ts` | Dashboard with stats |
| `persons-page.ts` | Person directory |
| `person-detail-page.ts` | Person profile view |
| `person-form-page.ts` | Create/edit person |
| `groups-page.ts` | Group directory |
| `group-detail-page.ts` | Group profile view |
| `group-form-page.ts` | Create/edit group |
| `achievements-page.ts` | Gamification hub |
| `invite-page.ts` | Send group invites |
| `system-admin-page.ts` | System settings |
| `admin-users-page.ts` | User management |
| `admin-interests-page.ts` | Interest management |
| `audit-logs-page.ts` | Audit trail |

### Components (`client/src/components/`)

**Layout** (`layout/`):
- `navigation.ts` - Top nav bar
- `app-layout.ts`, `page-layout.ts` - Layout wrappers
- `admin-nav.ts` - Admin navigation
- `masquerade-banner.ts` - Impersonation status

**UI** (`ui/`):
- `button.ts`, `input.ts` - Form elements
- `notification.ts` - Toast notifications
- `ui-spinner.ts` - Loading spinner
- `person-list.ts`, `person-search.ts` - Person components
- `group-list.ts`, `group-search.ts` - Group components
- `contact-info-form.ts`, `contact-info-display.ts` - Contact components
- `interests-form.ts` - Interest level slider
- `bulk-import-modal.ts` - CSV/TSV import
- `image-cropper-modal.ts` - Image upload/crop
- `achievement-card.ts`, `level-progress.ts` - Gamification UI
- `nearby-persons-and-groups.ts` - Location discovery
- `similar-persons-card.ts` - Recommendations

### Utilities (`client/src/utilities/`)
- `design-tokens.ts` - Tailwind constants
- `icons.ts` - SVG icons
- `fuzzy-search.ts` - Client-side search
- `validation.ts` - Form validation
- `tsv-parser.ts` - Bulk import parsing

## Shared Module (`shared/`)

- `shared/src/index.ts` - Main exports
- `shared/src/types.ts` - All TypeScript interfaces (User, Person, Group, ContactInformation, etc.)
- `shared/src/constants.ts` - Application constants

## Key Search Patterns

| Looking for... | Search in |
|----------------|-----------|
| Authentication | `service/src/routes/auth.ts`, `service/src/config/passport.ts`, `client/src/pages/login-page.ts` |
| Database schema | `service/prisma/schema.prisma` |
| Email sending | `service/src/lib/email.ts` |
| Input validation | `service/src/middleware/validation.ts` |
| API endpoints | `service/src/routes/*.ts` |
| Redux state | `client/src/store/slices/*.ts` |
| UI components | `client/src/components/ui/*.ts` |
| Page views | `client/src/pages/*.ts` |
| Type definitions | `shared/src/types.ts` |
| Admin features | Files with `admin` in name, `masquerade.ts` |
| Gamification | `gamification.ts`, `achievement-triggers.ts`, `achievements-page.ts` |
| Location/nearby | `geocoding.ts`, `nearby.ts`, `nearby-persons-and-groups.ts` |