generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ContactInformation {
  id             Int                        @id @default(autoincrement())
  type           ContactType
  label          String
  value          String
  latitude       Decimal?
  longitude      Decimal?
  privacy        PrivacyLevel
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt
  deleted        Boolean                    @default(false)
  groupContacts  GroupContactInformation[]
  personContacts PersonContactInformation[]
  systemContacts SystemContactInformation[]

  @@index([type])
  @@index([privacy])
  @@map("contact_information")
}

model User {
  id                 Int                  @id @default(autoincrement())
  email              String               @unique
  password           String
  verificationToken  String?
  isSystemAdmin      Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  deleted            Boolean              @default(false)
  claims             Claim[]
  people             Person[]
  emailChangeRequests EmailChangeRequest[]
  auditLogs          AuditLog[]
  userAchievements   UserAchievement[]
  pointTransactions  PointTransaction[]

  @@map("users")
}

model Person {
  id                 Int                        @id @default(autoincrement())
  firstName          String
  lastName           String
  displayId          String                     @unique
  pronouns           String?
  imageURL           String?
  userId             Int
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  deleted            Boolean                    @default(false)
  claims             Claim[]
  user               User                       @relation(fields: [userId], references: [id])
  contactInformation PersonContactInformation[]
  groupMemberships   PersonGroup[]
  interests         PersonInterest[]

  @@index([userId])
  @@map("people")
}

model System {
  id                 Int                        @id @default(1)
  name               String
  description        String?
  registrationOpen   Boolean                    @default(true)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  deleted            Boolean                    @default(false)
  contactInformation SystemContactInformation[]

  @@map("systems")
}

model Group {
  id                            Int                       @id @default(autoincrement())
  displayId                     String                    @unique
  name                          String
  description                   String?
  parentGroupId                 Int?
  allowsAnyUserToCreateSubgroup Boolean                   @default(false)
  publiclyVisible               Boolean                   @default(true)
  createdAt                     DateTime                  @default(now())
  updatedAt                     DateTime                  @updatedAt
  deleted                       Boolean                   @default(false)
  contactInformation            GroupContactInformation[]
  invites                       GroupInvite[]
  parentGroup                   Group?                    @relation("GroupHierarchy", fields: [parentGroupId], references: [id])
  childGroups                   Group[]                   @relation("GroupHierarchy")
  people                        PersonGroup[]

  @@index([parentGroupId])
  @@map("groups")
}

model Claim {
  id             Int       @id @default(autoincrement())
  personId       Int
  requestingUser Int
  claimCode      String    @unique
  claimed        Boolean   @default(false)
  claimedAt      DateTime?
  expiresAt      DateTime
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deleted        Boolean   @default(false)
  person         Person    @relation(fields: [personId], references: [id])
  user           User      @relation(fields: [requestingUser], references: [id])

  @@map("claims")
}

model GroupInvite {
  id         Int       @id @default(autoincrement())
  groupId    Int
  email      String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deleted    Boolean   @default(false)
  accepted   Boolean   @default(false)
  acceptedAt DateTime?
  group      Group     @relation(fields: [groupId], references: [id])

  @@map("group_invites")
}

model SystemContactInformation {
  id                   Int                @id @default(autoincrement())
  systemId             Int
  contactInformationId Int
  contactInformation   ContactInformation @relation(fields: [contactInformationId], references: [id])
  system               System             @relation(fields: [systemId], references: [id])

  @@unique([systemId, contactInformationId])
  @@map("system_contact_information")
}

model PersonContactInformation {
  id                   Int                @id @default(autoincrement())
  personId             Int
  contactInformationId Int
  contactInformation   ContactInformation @relation(fields: [contactInformationId], references: [id])
  person               Person             @relation(fields: [personId], references: [id])

  @@unique([personId, contactInformationId])
  @@map("person_contact_information")
}

model GroupContactInformation {
  id                   Int                @id @default(autoincrement())
  groupId              Int
  contactInformationId Int
  contactInformation   ContactInformation @relation(fields: [contactInformationId], references: [id])
  group                Group              @relation(fields: [groupId], references: [id])

  @@unique([groupId, contactInformationId])
  @@map("group_contact_information")
}

model PersonGroup {
  id       Int     @id @default(autoincrement())
  personId Int
  groupId  Int
  isAdmin  Boolean @default(false)
  group    Group   @relation(fields: [groupId], references: [id])
  person   Person  @relation(fields: [personId], references: [id])

  @@unique([personId, groupId])
  @@map("person_groups")
}

enum ContactType {
  EMAIL
  PHONE
  ADDRESS
  URL
}

model EmailChangeRequest {
  id              Int      @id @default(autoincrement())
  userId          Int
  newEmail        String
  verificationToken String @unique
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([verificationToken])
  @@map("email_change_requests")
}

enum PrivacyLevel {
  PRIVATE
  PUBLIC
}

model Interest {
  id        Int              @id @default(autoincrement())
  name      String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  deleted   Boolean          @default(false)
  personInterests PersonInterest[]

  @@index([deleted])
  @@map("interests")
}

model PersonInterest {
  id         Int      @id @default(autoincrement())
  personId   Int
  interestId Int
  level      Decimal  @db.Decimal(3, 2) // 0.00 to 1.00
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  person     Person   @relation(fields: [personId], references: [id])
  interest   Interest @relation(fields: [interestId], references: [id])

  @@unique([personId, interestId])
  @@index([personId])
  @@index([interestId])
  @@map("person_interests")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?
  method     String   // GET, POST, PUT, PATCH, DELETE
  path       String   // API endpoint path
  statusCode Int      // HTTP status code
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([method])
  @@map("audit_logs")
}

// Gamification System Models

model Achievement {
  id          Int      @id @default(autoincrement())
  key         String   @unique // e.g., "profile_complete", "first_private_address"
  name        String   // Display name
  description String   // What the achievement is for
  points      Int      // Points awarded
  category    AchievementCategory
  iconName    String?  // Icon identifier for UI
  sortOrder   Int      @default(0) // Display order in UI
  isActive    Boolean  @default(true) // Can disable achievements
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userAchievements UserAchievement[]

  @@index([category])
  @@index([isActive])
  @@map("achievements")
}

model UserAchievement {
  id            Int      @id @default(autoincrement())
  userId        Int
  achievementId Int
  completedAt   DateTime @default(now()) // Timestamp when earned
  createdAt     DateTime @default(now())

  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId]) // Can only earn once
  @@index([userId])
  @@index([achievementId])
  @@index([completedAt]) // For leaderboards
  @@map("user_achievements")
}

model Level {
  id              Int      @id @default(autoincrement())
  levelNumber     Int      @unique // 1, 2, 3, etc.
  name            String   // e.g., "Newcomer", "Community Member", "Active Participant"
  pointsRequired  Int      // Minimum points to reach this level
  description     String?  // What this level means
  iconName        String?  // Icon for this level
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([pointsRequired])
  @@map("levels")
}

model PointTransaction {
  id            Int      @id @default(autoincrement())
  userId        Int
  achievementId Int?     // Null for manual adjustments
  points        Int      // Can be negative for deductions
  reason        String   // Why points were awarded/deducted
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("point_transactions")
}

enum AchievementCategory {
  ONBOARDING
  PROFILE
  DISCOVERY
  SOCIAL
  PRIVACY
  ENGAGEMENT
}
